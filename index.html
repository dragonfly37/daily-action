<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Action Dashboard v3.1</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --min-bg: #f8f9fa; --more-bg: #fff9f0; --max-bg: #fff0f5; --accent: #333; }
        body { font-family: 'Pretendard', sans-serif; background: #eef1f4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .header { background: white; width: 100%; max-width: 900px; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1rem; width: 220px; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; }
        .category-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .category-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); color: var(--accent); }
        .level-group { margin-bottom: 15px; border-radius: 10px; padding: 10px; }
        .level-min { background: var(--min-bg); }
        .level-more { background: var(--more-bg); }
        .level-max { background: var(--max-bg); }
        .level-label { font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block; color: #666; }
        .action-item { display: flex; align-items: flex-start; margin-bottom: 6px; }
        .action-item input[type="checkbox"] { margin-top: 4px; margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .action-item label { font-size: 0.95rem; line-height: 1.4; color: #444; cursor: pointer; }
        .action-item input[type="text"] { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .action-item input:checked + label { text-decoration: line-through; color: #bbb; opacity: 0.7; }
        #sync-status { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 1000; font-weight: bold; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; margin-top: 10px; height: 12px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: #4caf50; transition: width 0.3s ease; }
        .btn-group { margin-top: 20px; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        #editBtn { background: #607d8b; color: white; }
        #saveBtn { background: #4caf50; color: white; display: none; margin-left: 10px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin-top:0;">ğŸ“‹ Daily Action Dashboard</h2>
    <input type="date" id="dateSelect">
    <div id="counter" style="margin-top:15px; font-weight:bold; color: #555;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
    <div id="cheerMessage" style="margin-top:10px; font-size: 1.1rem; font-weight: bold; color: #ff5722; min-height: 1.5rem;"></div>
    <div class="btn-group">
        <button id="editBtn" onclick="toggleEditMode()">âš™ï¸ í•­ëª© ìˆ˜ì • ëª¨ë“œ</button>
        <button id="saveBtn" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
    </div>
</div>

<div class="grid" id="mainGrid"></div>
<div id="sync-status">ë°ì´í„° ë™ê¸°í™” ì¤‘... ğŸš€</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwhcXMPTziRlZ8QMMnlXP1zMIllTKmVncFpGMtCF3s2PkMXFqVqAYiWPcVDsn7MDwN/exec";
    let isEditMode = false;
    let currentSettings = [];
    const dateInput = document.getElementById('dateSelect');
    const mainGrid = document.getElementById('mainGrid');
    const syncStatus = document.getElementById('sync-status');

    dateInput.value = new Date().toISOString().split('T')[0];

    async function render() {

        const selectedDate = dateInput.value;
        mainGrid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">ë°ì´í„° ë¡œë“œ ì¤‘...</p>';
        try {
            const setRes = await fetch(`${SCRIPT_URL}?action=getSettings&date=${selectedDate}`);
            currentSettings = await setRes.json();
            const logRes = await fetch(`${SCRIPT_URL}?date=${selectedDate}`);
            const completedItems = await logRes.json();

            if (currentSettings.length === 0) {
                mainGrid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">í•´ë‹¹ ë‚ ì§œì— ì„¤ì •ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ì • ëª¨ë“œì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</p>';
                return;
            }

            mainGrid.innerHTML = '';
            currentSettings.forEach((row, catIdx) => {
if (row[0] === "ì‹œì‘ì¼" || row[2] === "ì¹´í…Œê³ ë¦¬") return;
                const catName = row[2];
                const card = document.createElement('div');
                card.className = 'category-card';
                let cardHTML = isEditMode ? `<input type="text" class="cat-in" value="${catName}" style="width:100%; font-size:1.2rem; font-weight:800; margin-bottom:10px;">` : `<div class="category-title">${catName}</div>`;
                
                [{n:"Min",s:3,e:6,c:"level-min"},{n:"More",s:6,e:9,c:"level-more"},{n:"Max",s:9,e:12,c:"level-max"}].forEach(l => {
                    cardHTML += `<div class="level-group ${l.c}"><span class="level-label">${l.n}</span>`;
                    for(let i=l.s; i<l.e; i++) {
                        const item = row[i] || "";
                        if(isEditMode) cardHTML += `<div class="action-item"><input type="text" class="item-in" value="${item}"></div>`;
                        else if(item) cardHTML += `<div class="action-item"><input type="checkbox" id="i-${catIdx}-${i}" ${completedItems.includes(item)?'checked':''} onchange="sync('${catName}','${l.n}','${item}',this.checked)"><label for="i-${catIdx}-${i}">${item}</label></div>`;
                    }
                    cardHTML += `</div>`;
                });
                card.innerHTML = cardHTML;
                mainGrid.appendChild(card);
            });
            updateCounter();
        } catch (e) { mainGrid.innerHTML = '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>'; }
    }

    async function sync(cat, lvl, item, checked) {
        updateCounter();
        syncStatus.style.display = 'block';
        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ date: dateInput.value, category: `${cat}(${lvl})`, workout: item, isChecked: checked })
            });
        } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); }
        syncStatus.style.display = 'none';
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('editBtn').innerText = isEditMode ? "ì·¨ì†Œ" : "âš™ï¸ í•­ëª© ìˆ˜ì • ëª¨ë“œ";
        document.getElementById('saveBtn').style.display = isEditMode ? "inline-block" : "none";
        render();
    }

    async function saveSettings() {
        if(!confirm("ì„¤ì •ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        syncStatus.style.display = 'block';
        const newSet = [];
        document.querySelectorAll('.category-card').forEach(card => {
            const row = [dateInput.value, "2099-12-31", card.querySelector('.cat-in').value];
            card.querySelectorAll('.item-in').forEach(input => row.push(input.value));
            newSet.push(row);
        });
        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "updateSettings", settings: newSet }) });
            alert("ì €ì¥ ì™„ë£Œ!");
            toggleEditMode();
        } catch (e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
        syncStatus.style.display = 'none';
    }

    function updateCounter() {
        const boxes = document.querySelectorAll('input[type="checkbox"]');
        const checked = document.querySelectorAll('input[type="checkbox"]:checked');
        document.getElementById('counter').innerText = `ì˜¤ëŠ˜ ${checked.length} / ${boxes.length} ë‹¬ì„± ì¤‘!`;
        document.getElementById('progressBar').style.width = (boxes.length > 0 ? (checked.length/boxes.length)*100 : 0) + '%';
        if (checked.length > 0 && !isEditMode) {
            if (checked.length === boxes.length) { fireFinalConfetti(); }
            else if (checked.length % 10 === 0) fireStepConfetti();
        }
    }

    function fireStepConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
    function fireFinalConfetti() { 
        const end = Date.now() + 3000;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    dateInput.addEventListener('change', render);
    render();
</script>
</body>
</html>
